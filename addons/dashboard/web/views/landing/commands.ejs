<section class="hero text-center py-5" style="margin-top: 160px;">
    <div class="container" style="padding-top: 50px; padding-bottom: 30px;">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bolder mb-3">
                    <img src="/assets/img/logo/logo.png" alt="logo" width="60"> <span class="hero-title">Kythia</span> Commands
                </h1>
                <p class="lead mb-4" style="max-width: 700px; margin: 0 auto;">
                    Explore all available commands for Kythia. there is <%= totalCommands %> commands!
                </p>
            </div>
        </div>
    </div>
</section>
<div class="container" style="margin-top: 160px;">
    <div class="row">
        <div class="col-lg-3 d-none d-lg-block">
            <div class="sticky-lg-top ">
                <h5 class="fw-semibold mb-3">Categories</h5>
                <div class="list-group" id="category-list">
                    <a href="#"
                        class="list-group-item border-1 border-primary border-opacity-25 list-group-item-action d-flex justify-content-between align-items-center active"
                        data-category="all"
                        id="cat-all">
                        All Commands
                        <span class="badge bg-primary rounded-pill">
                            <%= totalCommands %>
                        </span>
                    </a>
                    <% categories.forEach(function(category) { %>
                        <a href="#"
                            class="list-group-item border-1 border-primary border-opacity-25 list-group-item-action d-flex justify-content-between align-items-center text-capitalize"
                            data-category="<%= category %>"
                            id="cat-<%= category %>">
                            <%= category.replace(/_/g, ' ' ) %>
                                <span class="badge bg-primary rounded-pill">
                                    <% let categoryCount=0; commands.filter(c=> c.category ===
                                        category).forEach(c => {
                                        if (c.subcommands && c.subcommands.length > 0) {
                                        categoryCount += c.subcommands.length;
                                        } else {
                                        categoryCount += 1;
                                        }
                                        });
                                        %>
                                        <%= categoryCount %>
                                </span>
                        </a>
                    <% }); %>
                </div>
            </div>
        </div>

        <div class="col-lg-9 mt-4 mt-lg-0">
            <div class="input-group mb-4">
                <input type="text" id="command-search" class="form-control search-bar" placeholder="Search command...">
            </div>
            <div class="accordion " id="commands-accordion">

                <% commands.forEach(function(command, index) { %>
                    <div class="accordion-item glass-effect command-item" data-category="<%= command.category %>"
                        data-name="<%= command.name %>">
                        <h2 class="accordion-header">
                            <button class="accordion-button glass-effect collapsed fs-5" type="button"
                                data-bs-toggle="collapse" data-bs-target="#cmd-<%= index %>">
                                <% if (command.isContextMenu) { %>
                                    <% if (command.type === 'user') { %>
                                        <i class="fa-solid fa-user me-2" style="width: 20px;" data-bs-toggle="tooltip" data-bs-title="User Context Menu"></i>
                                    <% } else { %>
                                        <i class="fa-solid fa-message me-2" style="width: 20px;" data-bs-toggle="tooltip" data-bs-title="Message Context Menu"></i>
                                    <% } %>
                                    <span class="fw-semibold"><%= command.name %></span>
                                <% } else { %>
                                    <i class="fa-regular fa-slash-forward" data-bs-toggle="tooltip" data-bs-title="Slash Command"></i><%= command.name %>
                                <% } %>
                            </button>
                        </h2>
                        <div id="cmd-<%= index %>" class="accordion-collapse collapse"
                            data-bs-parent="#commands-accordion">
                            <div class="accordion-body pt-4">
                                <p class="">
                                    <%= command.description %>
                                </p>

                                <% if (command.subcommands && command.subcommands.length> 0) { %>
                                    <h6 class=" mt-4 mb-3">SUBCOMMANDS</h6>

                                    <% command.subcommands.forEach(function(sub) { %>
                                        <div class="subcommand mb-4">
                                            <p class="mb-1"><code
                                                    class="fs-5 ">/<%= command.name %> <%= sub.name %></code>
                                            </p>
                                            <p class="ms-1">
                                                <%= sub.description %>
                                                <% if (sub.aliases && sub.aliases.length > 0) { %>
                                                    <div class="mt-1">
                                                        <small class="text-muted">Aliases: 
                                                            <% sub.aliases.forEach(function(alias, i) { %>
                                                                <code><%= alias %></code><% if (i < sub.aliases.length - 1) { %>, <% } %>
                                                            <% }); %>
                                                        </small>
                                                    </div>
                                                <% } %>
                                            </p>

                                            <% if (sub.options && sub.options.length> 0) { %>
                                                <table class="table table-borderless responsive table-sm small mt-2">
                                                    <thead>
                                                        <tr>
                                                            <th class="" style="width: 20%;">Option
                                                            </th>
                                                            <th class="">Description</th>
                                                            <th class="" style="width: 15%;">Type</th>
                                                            <th class=" text-center" style="width: 10%;">
                                                                Required
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% sub.options.forEach(function(opt) { %>
                                                            <tr>
                                                                <td><code><%= opt.name %></code></td>
                                                                <td>
                                                                    <%= opt.description %>
                                                                </td>
                                                                <td>
                                                                    <%= opt.type %>
                                                                </td>
                                                                <td class="text-center">
                                                                    <%= opt.required ? '✅' : '❌' %>
                                                                </td>
                                                            </tr>
                                                            <% if (opt.choices) { %>
                                                                <tr>
                                                                    <td></td>
                                                                    <td colspan="3"><small class="">Choices:
                                                                            <%- opt.choices %></small></td>
                                                                </tr>
                                                            <% } %>
                                                        <% }); %>
                                                    </tbody>
                                                </table>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                <% } else if (command.options && command.options.length> 0) { %>
                                    <h6 class=" mt-4 mb-3">OPTIONS</h6>
                                    <table class="table table-borderless table-sm small mt-2">
                                        <thead>
                                            <tr>
                                                <th class="" style="width: 20%;">Option
                                                </th>
                                                <th class="">Description</th>
                                                <th class="" style="width: 15%;">Type</th>
                                                <th class=" text-center" style="width: 10%;">
                                                    Required
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% command.options.forEach(function(opt) { %>
                                                <tr>
                                                    <td><code><%= opt.name %></code></td>
                                                    <td>
                                                        <%= opt.description %>
                                                    </td>
                                                    <td>
                                                        <%= opt.type %>
                                                    </td>
                                                    <td class="text-center">
                                                        <%= opt.required ? '✅' : '❌' %>
                                                    </td>
                                                </tr>
                                                <% if (opt.choices) { %>
                                                    <tr>
                                                        <td></td>
                                                        <td colspan="3"><small class="">Choices:
                                                                <%- opt.choices %></small></td>
                                                    </tr>
                                                <% } %>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
                <div id="no-results" class="text-center py-5" style="display: none;">
                    <i class="fa-solid fa-search fs-1"></i>
                    <h4 class="mt-3">No commands found</h4>
                    <p class="">Try a different search term.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('command-search');
        const commandItems = document.querySelectorAll('.command-item');
        const categoryLinks = document.querySelectorAll('#category-list .list-group-item');
        const noResults = document.getElementById('no-results');

        function filterCommands(searchTerm, category) {
            let visibleCount = 0;
            const search = searchTerm.trim().toLowerCase();

            commandItems.forEach(item => {
                const commandName = item.dataset.name ? item.dataset.name.toLowerCase() : '';
                const itemCategory = item.dataset.category;
                const button = item.querySelector('.accordion-button');
                const buttonText = button ? button.textContent.toLowerCase() : '';
                const matchesSearch = commandName.includes(search) || buttonText.includes(search);
                const matchesCategory = (category === 'all' || itemCategory === category);

                if (matchesSearch && matchesCategory) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            if (noResults) {
                noResults.style.display = visibleCount === 0 ? '' : 'none';
            }
        }

        let activeCategory = 'all';

        // Helper for scroll and click if needed
        function setActiveCategory(cat) {
            activeCategory = cat;
            categoryLinks.forEach(l => l.classList.remove('active'));
            // Add active class to the found link
            let activeLink = Array.from(categoryLinks).find(
                l => l.dataset.category === cat
            );
            if (activeLink) activeLink.classList.add('active');
        }

        // Read hash from location to select category on load
        function readHashCategory() {
            const hash = window.location.hash;
            if (!hash || hash.length < 2) return 'all';
            return hash.substring(1); // remove "#"
        }

        function updateCategoryFromHash() {
            const selected = readHashCategory();
            // Check if this category exists, else fallback
            const existing = Array.from(categoryLinks).some(l => l.dataset.category === selected);
            const useCat = existing ? selected : 'all';
            setActiveCategory(useCat);
            filterCommands(searchInput.value, useCat);
        }

        // Initial activation from URL hash
        updateCategoryFromHash();

        searchInput.addEventListener('input', () => {
            filterCommands(searchInput.value, activeCategory);
        });

        categoryLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const cat = this.dataset.category;
                setActiveCategory(cat);
                // Change hash in URL (don't scroll to anchor)
                if (cat === 'all') {
                    history.replaceState(null, '', window.location.pathname);
                } else {
                    window.location.hash = '#' + cat;
                }
                filterCommands(searchInput.value, cat);
            });
        });

        // Listen for hash change (user can manually change hash or use browser nav)
        window.addEventListener('hashchange', function () {
            updateCategoryFromHash();
        });
    });
</script>